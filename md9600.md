# MD-9600
 
## Specifications
### Frequency range
* VHF: 136.000-174.000
* UHF: 400.000-480.000

## Hardware components
### Clock tree configuration
To be found

### UI GPIO mapping
* PC6 - display backlight
* PD2 - "P1" button, active low
* PD3 - red "emergency" button, active low
* PD4 - power button, active low
* PE10 - PTT key, active low
* PB10 - encoder
* PB11 - encoder

### Display
The display is a monochrome 128x64 pixel LCD with an ST7567 controller. Command and data are sent through an SPI interface connected to the SPI2 peripheral, shared with the external flash memory. The other GPIOs are:
* PD12 - reset, active low
* PD13 - data/command (A0 on controller datasheet)
* PD14 - chip select, active low

Framebuffer starts at address 0x2001ac08.

Backlight is controlled by PC6 and dimming is controlled by TIM8_CH1.

Functions identified:
* 0x0804c278 - initialisation routine
* 0x0804c1b8 - send command
* 0x0804c218 - send data
* 0x08025bb0 - clear screen and framebuffer

* 0x0804acc6: function configuring backlight GPIO
* 0x0804ad48: function for turning on LCD backlight, with brightness control
* 0x0804adc8: function for turning off LCD backlight

### HR_C6000
The SPI control interface is connected to the following GPIOs:
* PE2 - chip select
* PE3 - SCK
* PE4 - SDI
* PE5 - SDO

These SPI connections are shared with some other chip, since the firwmare locks a semaphore/mutex before initiating any kind of data transfer through the SPI interface. The semaphore variable is at address 0x2001EC90.

Functions identified:
* 0x080710e6 - software SPI implementation for the control interface
* 0x08071152 - function for sending a data block through the control interface
* 0x08071192 - function to acquire exclusive ownership of the SPI GPIOs and select the HR_C6000
* 0x080711aa - function releasing exclusive ownership of the SPI GPIOs and deselecting the HR_C6000
* 0x08051168 - function for writing to a control RAM register
* 0x08050674 - function where the code for the main HR_C6000 configuration resides.

### PLL
There are two PLLs, configured by the "RF PLL" task. At least in the older models, the PLLs are Skyworks SKY72310 and they are configured through an SPI interface.
The PLL SPI interface occupies the following GPIOs:
* PD8  - chip select of PLL 1
* PD9  - chip select of PLL 2
* PD10 - SDO
* PD11 - SCK

Data is sent through a bit-banging routine located at address 0x0806a296.

### External flash memory
The external flash memory for CPS and calibration data storage is a Winbond W25Q128. Data is exchanged through the SPI2 peripheral and chip select seems to be PB12. The SPI bus is shared with the LCD controller and at least another peripheral whose chip select is on PB13.

Functions identified:
* 0x080463fc - function reading a data block from main memory
* 0x08046824 - function reading a data block from a security register
* 0x080464ae - function to acquire exclusive ownership of the SPI GPIOs and select the external flash
* 0x080464d8 - function releasing exclusive ownership of the SPI GPIOs and deselecting the external flash

Calibration data are stored in security registers at addresses 0x1000 and 0x2000 and are loaded into a 512-byte RAM block starting from address 0x2001BE14. The function loading the calibration data from the security registers is at address 0x0802b9c8.

### ADCs
The STM32F405 microcontroller has three Analog to Digital Converters, here is how they are used in the original MD-9600 firwmare.

##### ADC1
ADC1 is initialised in the function starting at 0x080664aa, and configured for the sampling of eight channels through a regular sequence of conversions. Conversion order is: ADC1_IN9 (PB1), ADC1_IN15 (PC5), ADC1_IN8 (PB0), ADC1_IN0 (PA0), ADC1_IN3 (PA3), ADC1_IN1 (PA1), ADC1_IN6 (PA6), ADC1_IN7 (PA7). Data is transferred through DMA2_Stream0 to a sample buffer starting at 0x2001e8d4, from here the samples are retrieved and processed in various functions in the firmware image.

##### ADC2
ADC2 is initialised in the function starting at 0x080664aa, and configured for the sampling ADC2_IN13 (PC13). Data is transferred through DMA2_Stream3 to a buffer starting at 0x2001c014. The IRQ handler for DMA2_Stream3, at address 0x080b2d38, copies data from the sample buffer to another buffer located at 0x2001c214 and, before exiting, sends a signal to a task through the semaphore at address 0x2001ecb8.

Data is processed by a task whose function body is located at 0x0806b308. This task is spawned by the function at 0x0806b1b8 and is assigned the name "Tone fft": from this we can conclude that PC13 is connected to the analog audio output of the receiver stage and is used for CTCSS/DCS and DTMF decoding through the FFT task.

##### ADC3
ADC2 is initialised in the function starting at 0x0804b160, and configured for the sampling ADC2_IN2 (PA2). Where the data is processed is yet to be discovered, anyway no DMA transfer is involved.

## Memory mapping

### Flash - other functions not listed in the above blocks
* 0x08049924: function starting various system tasks

### RAM
* 0x2001AC08: start of display framebuffer
* 0x2001EC90: semaphore for concurrent access to HR_C6000 control SPI bus
* 0x2001BE14: calibration data
* 0x2001E8D4: ADC1 sample buffer
* 0x2001C014: ADC2 sample buffer
* 0x2001C214: FFT buffer
* 0x2001ECB8: semaphore signalling that new data for FFT processing are available
* 0x2001EC8C: semaphore for concurrent access to SPI2, shared between external flash and LCD

## System tasks

### "Sys Inter" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x080505fc  |  0x20013448   |  7  |    7

### "RTC Timer" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x08049c38  |  0x20012C48   | 23  |   23

### "Call Process" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0805d790  |  0x20013c48   | 20  |   20

### "FMTx Process" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x08049fdc  |  0x20014448   | 21  |   21

### "RF PLL" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0804a46c  |  0x20018804   |  6  |   6

### "PC Tune" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0804a490  |  0x20014C48   | 24  |   24

### "LED Process" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x080bc4b8  |  0x20018C04   |  25 |   25

### "BEEP Process" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x08043fc0  |  0x20019004   | 26  |   26

### "AF Mute" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x080452cc  |  0x20019404   | 13  |   13

### "TimeSlot" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x08050636  |  0x20015448   |  8  |    8

### "Set Vocoder" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0804552c  |  0x20019804   | 15  |   15

### "ChAccess" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0806063c  |  0x20019C04   | 17  |   17

### "State Change" task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0805e3b8  |  0x2001A004   | 18  |   18

### "TMDA State" first task 
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0805e8b0  |  0x2001A804   | 16  |   16

### "TMDA State" second task
Body address | Stack address | ID  | Priority
     ---     |      ---      | --- |   ---
 0x0805728c  |  0x2001A404   |  5  |    5
